# 📅 FleetPulse Weekly Reset System

## 📋 **AUTOMATIC WEEKLY RESET & EMAIL SYSTEM**

---

## **1. 🎯 OVERVIEW**

### **What the Weekly Reset Does:**
1. **Sends Email Report** → All notes, writeups, training data to `prush@mail.com`
2. **Clears All Data** → Resets notes, writeups, training for new week
3. **Updates Calendar** → Automatically shifts to next week's dates
4. **Backs Up Data** → Saves previous week's data for reference

---

## **2. 📧 EMAIL REPORT SYSTEM**

### **Step 2.1: Email Content Structure**

```typescript
// Format for weekly email report:
const emailContent = `
FLEETPULSE WEEKLY REPORT
Week of: ${currentWeekString}
Generated: ${new Date().toLocaleDateString()}

=== WEEKLY SUMMARY ===
Total Notes: ${totalNotes}
Total Writeups: ${totalWriteups}
Total Training Sessions: ${totalTraining}
Overall Completion: ${completionRate}%

=== NOTES BY DAY ===
Monday (${mondayDate}):
  DMV: ${mondayDMVNotes}
  NYC: ${mondayNYCNotes}

Tuesday (${tuesdayDate}):
  DMV: ${tuesdayDMVNotes}
  NYC: ${tuesdayNYCNotes}

... (continue for all days)

=== WRITEUPS ===
${formattedWriteups}

=== TRAINING SESSIONS ===
${formattedTraining}

=== CALL-OUTS & INCIDENTS ===
${formattedIncidents}

---
Report generated by FleetPulse System
`;
```

### **Step 2.2: Email Sending Function**

```typescript
// Add to NotesContext.tsx:
const sendWeeklyReport = async () => {
  try {
    const reportContent = generateWeeklyReport();
    
    const response = await fetch(`${EMAIL_API_URL}/api/send-email`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        recipient: 'prush@mail.com',
        subject: `FleetPulse Weekly Report - ${getCurrentWeek().weekString}`,
        content: reportContent
      })
    });

    if (response.ok) {
      showToast('✅ Weekly report sent successfully!');
    } else {
      throw new Error('Failed to send email');
    }
  } catch (error) {
    showToast('❌ Failed to send weekly report');
    console.error('Email error:', error);
  }
};
```

---

## **3. 🔄 WEEKLY RESET FUNCTION**

### **Step 3.1: Reset Implementation**

```typescript
// Add to NotesContext.tsx:
const resetWeeklyData = async () => {
  try {
    // 1. Send email report first
    await sendWeeklyReport();
    
    // 2. Backup current data
    await backupWeeklyData();
    
    // 3. Clear all data
    setWeeklyLog(initWeeklyLog());
    setWriteups(initWriteups());
    setTraining(initTraining());
    
    // 4. Update week tracking
    updateCurrentWeek();
    
    showToast('✅ Week reset successfully! New week started.');
  } catch (error) {
    showToast('❌ Reset failed. Please try again.');
    console.error('Reset error:', error);
  }
};
```

### **Step 3.2: Data Backup System**

```typescript
// Backup previous week's data:
const backupWeeklyData = async () => {
  const backupData = {
    week: getCurrentWeek().weekString,
    date: new Date().toISOString(),
    weeklyLog,
    writeups,
    training
  };
  
  await AsyncStorage.setItem(
    `fleetpulse_backup_${Date.now()}`, 
    JSON.stringify(backupData)
  );
};
```

---

## **4. 📅 CALENDAR DATE MANAGEMENT**

### **Step 4.1: Week Calculation**

```typescript
// In utils/dateUtils.ts:
export const getCurrentWeek = () => {
  const now = new Date();
  const startOfWeek = new Date(now);
  const day = startOfWeek.getDay();
  const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // Monday
  startOfWeek.setDate(diff);
  
  const weekString = `Week of ${startOfWeek.toLocaleDateString()}`;
  
  return {
    weekString,
    startDate: startOfWeek,
    endDate: new Date(startOfWeek.getTime() + 6 * 24 * 60 * 60 * 1000)
  };
};

export const getNextWeek = () => {
  const currentWeek = getCurrentWeek();
  const nextWeek = new Date(currentWeek.startDate);
  nextWeek.setDate(nextWeek.getDate() + 7);
  
  return {
    weekString: `Week of ${nextWeek.toLocaleDateString()}`,
    startDate: nextWeek,
    endDate: new Date(nextWeek.getTime() + 6 * 24 * 60 * 60 * 1000)
  };
};
```

### **Step 4.2: Date Display Updates**

```typescript
// Example: Reset on Friday 9/26
// Monday becomes: 9/29
// Tuesday becomes: 9/30
// Wednesday becomes: 10/1
// etc.

const getDayDate = (dayIndex: number) => {
  const week = getCurrentWeek();
  const dayDate = new Date(week.startDate);
  dayDate.setDate(dayDate.getDate() + dayIndex);
  return dayDate.toLocaleDateString();
};
```

---

## **5. 🎛️ RESET TRIGGER SYSTEM**

### **Step 5.1: Manual Reset Button**

```typescript
// Add to Overview screen:
const handleWeeklyReset = () => {
  Alert.alert(
    'Reset Week',
    'This will send the weekly report and clear all data for the new week. Continue?',
    [
      { text: 'Cancel', style: 'cancel' },
      { 
        text: 'Reset Week', 
        style: 'destructive',
        onPress: () => resetWeeklyData()
      }
    ]
  );
};

// In render:
<Pressable style={styles.resetButton} onPress={handleWeeklyReset}>
  <Ionicons name="refresh" size={20} color="#fff" />
  <Text style={styles.resetButtonText}>Reset Week</Text>
</Pressable>
```

### **Step 5.2: Automatic Reset (Optional)**

```typescript
// Auto-reset every Friday at 5 PM:
useEffect(() => {
  const checkAutoReset = () => {
    const now = new Date();
    const day = now.getDay(); // 0 = Sunday, 5 = Friday
    const hour = now.getHours();
    
    if (day === 5 && hour === 17) { // Friday 5 PM
      resetWeeklyData();
    }
  };
  
  const interval = setInterval(checkAutoReset, 60000); // Check every minute
  return () => clearInterval(interval);
}, []);
```

---

## **6. 📊 EMAIL TEMPLATE EXAMPLES**

### **Step 6.1: Complete Email Template**

```typescript
const generateWeeklyReport = () => {
  const week = getCurrentWeek();
  const stats = getStatistics();
  
  return `
FLEETPULSE WEEKLY REPORT
${week.weekString}
Generated: ${new Date().toLocaleDateString()}

=== SUMMARY ===
📝 Total Notes: ${stats.totalNotes}
⚠️  Total Writeups: ${stats.totalWriteups}
🎓 Training Sessions: ${stats.totalTraining}
✅ Completion Rate: ${stats.completionRate}%
📞 Call-outs: ${stats.callOuts}

=== DAILY BREAKDOWN ===
${DAYS.map(day => {
  const dayDate = getDayDate(DAYS.indexOf(day));
  const dmvNotes = weeklyLog[day]?.dmv || '';
  const nycNotes = weeklyLog[day]?.nyc || '';
  const dayWriteups = writeups[day] || { dmv: [], nyc: [] };
  const dayTraining = training[day] || [];
  
  return `
${day} (${dayDate}):
  📝 DMV Notes: ${dmvNotes || 'No notes'}
  📝 NYC Notes: ${nycNotes || 'No notes'}
  ⚠️  Writeups: ${dayWriteups.dmv.length + dayWriteups.nyc.length} total
  🎓 Training: ${dayTraining.length} sessions
`;
}).join('\n')}

=== DETAILED WRITEUPS ===
${formatWriteupsForEmail()}

=== TRAINING SESSIONS ===
${formatTrainingForEmail()}

---
Report generated by FleetPulse System
Contact: [Your Contact Info]
`;
};
```

---

## **7. 🔧 IMPLEMENTATION CHECKLIST**

### **Step 7.1: Add to NotesContext.tsx**
- [ ] Add `sendWeeklyReport` function
- [ ] Add `resetWeeklyData` function
- [ ] Add `backupWeeklyData` function
- [ ] Add email API integration

### **Step 7.2: Add to Overview Screen**
- [ ] Add "Reset Week" button
- [ ] Add confirmation dialog
- [ ] Add loading states
- [ ] Add success/error messages

### **Step 7.3: Test Email System**
- [ ] Test email sending
- [ ] Verify email content format
- [ ] Test with different data scenarios
- [ ] Verify recipient receives emails

### **Step 7.4: Test Reset System**
- [ ] Test manual reset
- [ ] Verify data clearing
- [ ] Verify calendar updates
- [ ] Test backup system

---

## **8. 🎯 USER WORKFLOW**

### **Weekly Reset Process:**
1. **Friday End of Day** → Manager reviews week
2. **Click "Reset Week"** → Confirmation dialog appears
3. **Confirm Reset** → System sends email report
4. **Email Sent** → Report delivered to `prush@mail.com`
5. **Data Cleared** → All notes/writeups/training reset
6. **New Week Starts** → Calendar updates to next week
7. **Ready for Monday** → Fresh start for new week

### **Email Recipients:**
- **Primary**: `prush@mail.com` (HR Manager)
- **Secondary**: `[Your Email]` (Backup)
- **Optional**: Additional team members

---

## **9. 🔒 DATA SAFETY**

### **Backup System:**
- All previous week data is backed up
- Backups stored locally on device
- Can be restored if needed
- Automatic cleanup of old backups (keep last 4 weeks)

### **Error Handling:**
- If email fails, reset is cancelled
- If reset fails, data is preserved
- User is notified of any issues
- Manual retry options available

---

**🎉 Your FleetPulse weekly reset system is ready for production use!**
